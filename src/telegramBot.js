import { request } from 'https';
import { dbGet, dbRun } from './db.js';

const TELEGRAM_TOKEN = '7212456462:AAEGw79rGEFC_kaJNb5Cr6wI6UD_UJwGGaA';

function botApi(name, data) {
    return new Promise(function(resolve, reject) {
        const req = request({
            method: 'POST',
            host: 'api.telegram.org',
            path: `/bot${TELEGRAM_TOKEN}/${name}`,
            headers: { 'Content-Type': 'application/json' }
        }, function(res) {
            res.setEncoding('utf8');
            let body = '';
            res.on('data', chunk => body += chunk);
            res.on('end', () => resolve(JSON.parse(body)));
        });
        req.on('error', reject);
        req.end(JSON.stringify(data));
    });
}

function sendMessage(chatId, text) {
    return botApi('sendMessage', { chat_id: chatId, text, parse_mode: 'HTML' });
}
export function sendMessageWithKeyboard(chatId, text) {
    return botApi('sendMessage', {
        chat_id: chatId, text, parse_mode: 'HTML', reply_markup: {
            keyboard: [
                ['üë§ –û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ'],
                ['‚ùå –û—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç']
            ]
        }
    });
}

export default async function initTelegramBot(db) {
    let offset = 0;
    while (true) {
        const { ok, result } = await botApi('getUpdates', { offset, timeout: 5000 });
        if (ok) {
            offset += result.length;
            for (const { update_id, message } of result) {
                dbGet(db, 'SELECT * FROM users WHERE telegram = ?', message.from.id).then(async function([user]) {
                    switch (message.text) {
                        case '/start':
                            await (user ? sendMessageWithKeyboard : sendMessage)(message.chat.id, '<b>–û–± —ç—Ç–æ–º –±–æ—Ç–µ:</b>\n–ë–æ—Ç —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞–º –æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –ö—Ä–æ–Ω—ã. –û—Ç–º–µ—Ç—å—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –æ—Ç–º–µ—Ç—å—Ç–µ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ç–µ–ª–µ–≥—Ä–∞–º" –Ω–∞ —Å–∞–π—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–±—ã—Ç–∏—è—Ö.');
                            break;
                        case 'üë§ –û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ':
                            if (!user) return sendMessage(message.chat.id, '–≠—Ç–æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∞–∫–∫–∞—É–Ω—Ç—É.');
                            sendMessageWithKeyboard(message.chat.id, `<u><b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:</b></u>
<b>–§–ò–û:</b> ${user.first_name} ${user.second_name} ${user.third_name}
<b>–ü–æ—á—Ç–∞:</b> ${user.email ?? '&lt;–Ω–µ—Ç&gt;'}
<b>–†–æ–ª—å:</b> ${['–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '—Ä–µ–∑–∏–¥–µ–Ω—Ç', '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'][user.role]}
<b>–ì–æ—Ä–æ–¥:</b> ${user.city}
<b>–°—Ç—Ä–∞–Ω–∞:</b> ${user.country}`, { parse_mode: 'HTML' });
                            break;
                        case '‚ùå –û—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç':
                            if (!user) return sendMessage(message.chat.id, '–≠—Ç–æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∞–∫–∫–∞—É–Ω—Ç—É.');
                            if (user.password === null) return sendMessageWithKeyboard(message.chat.id, '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–≤—è–∑–∞—Ç—å —Ç–µ–ª–µ–≥—Ä–∞–º –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –±–µ–∑ –ø–∞—Ä–æ–ª—è.');
                            dbRun(db, 'UPDATE users SET telegram = NULL WHERE id = ?', user.id);
                            sendMessage(message.chat.id, '–í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤—è–∑–∞–ª–∏ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç.');
                            break;
                        default:
                            if (/^[0-9a-f]{32}$/.test(message.text)) {
                                dbGet(db, 'SELECT type, telegram FROM telegram_auth WHERE code = ?', message.text).then(async function([auth]) {
                                    if (!auth) return sendMessage(message.chat.id, '–ö–æ–¥ –Ω–µ–¥–µ–∏ÃÜ—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω.');
                                    if (auth.telegram !== null) return sendMessage(message.chat.id, '–í—ã —É–∂–µ –≤–≤–æ–¥–∏–ª–∏ —ç—Ç–æ—Ç –∫–æ–¥.');
                                    if (auth.type === 1) { // register
                                        const [user] = await dbGet(db, 'SELECT id FROM users WHERE telegram = ?', message.from.id);
                                        if (user) return sendMessageWithKeyboard(message.chat.id, '–≠—Ç–æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∞–∫–∫–∞—É–Ω—Ç—É.');
                                    }
                                    await dbRun(db, 'UPDATE telegram_auth SET telegram = ? WHERE code = ?', message.from.id, message.text);
                                    sendMessageWithKeyboard(message.chat.id, `–í—ã —É—Å–ø–µ—à–Ω–æ ${['–≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É', '–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å'][auth.type]}. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å".`);
                                });
                            }
                            else (user ? sendMessageWithKeyboard : sendMessage)(message.chat.id, '–Ø –Ω–µ –ø–æ–Ω—è–ª, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –º–Ω–µ —Å–æ–æ–±—â–∏—Ç—å.');
                    }
                });
                offset = update_id + 1;
            }
        }
    }
}